/* настройки ядра для работы демона

Для работы с Posix IPC очередью сообщений (процессы базы данных и диалога с терминалами)
необходимо увеличить/проверить ограничения на:
максимальное кол-во сообщений в очереди (демон использует значение 16384):
(/proc/sys/fs/mqueue/msg_max) The default value for msg_max is 10. The minimum value is 1 (10 in kernels before 2.6.28). The upper limit is HARD_MAX: (32768 on Linux/86)
максимальный размер сообщения (демон использует значение 8192):
(/proc/sys/fs/mqueue/msgsize_max) The default value for msgsize_max is 8192 bytes. The minimum value is 128 (8192 in kernels before 2.6.28). The upper limit for msgsize_max is INT_MAX: 1,048,576
максимальное кол-во очередей (демон использует значение 2):
(/proc/sys/fs/mqueue/queues_max) The default value for queues_max is 256; it can be changed to any value in the range 0 to INT_MAX: 1,048,576

системное ограничение RLIMIT_MSGQUEUE в файле /etc/security/limits.conf должно быть установлено
для пользователя, от имени которого запускается демон в значение, рассчитанное по формуле:
msgqueue = 10 * attr.mq_maxmsg * attr.mq_msgsize
так:
@glonassd   -   msgqueue    1342177280
или так (для всех)
*	hard	msgqueue	1342177280


Если это не помогает и получаем ошибку:  mq_open error 24: Too many open files
то смотреть здесь:
http://stackoverflow.com/questions/19250492/mq-open-giving-too-many-open-files
http://stackoverflow.com/questions/5285101/why-is-there-a-error-cannot-allocate-memory-while-creating-message-queue-in-po
и здесь:
http://linux.die.net/man/2/setrlimit


For automatic daemon start:
1 create folder for daemon:
mkdir /opt/glonassd

2 copy daemon files to created folder

3 write startup script in /etc/init.d (see glonassd.sh &
http://www.it-simple.ru/?p=7561
http://doc.ubuntu-fr.org/tutoriel/comment_transformer_un_programme_en_service
)

4 set access rigth
chmod 0755 /etc/init.d/glonassd.sh

5 reload system daemons info
systemctl daemon-reload

6 test start/stop daemon
/etc/init.d/glonassd.sh start
(
if shell error: "/bin/sh^M: плохой интерпретатор: Нет такого файла или каталога"
| "/bin/sh^M : bad interpreter..."
then script contains windows-style line feeds, to remove it do:
sed -i 's/\r//' /etc/init.d/glonassd.sh
)

7 configure autostart by:
( http://debian-help.ru/articles/avtozgruzka-debian/
-n - ничего не делать, только показать что будет сделано
-f - заставить удалять символические ссылки
)
update-rc.d glonassd.sh defaults

Бывает, что после перекомпиляции демон не стартует командами
service glonassd start
/etc/init.d/glonassd.sh start

Помогает удалить демон из автозагрузки и снова вставить в автозагрузку:
update-rc.d -f glonassd.sh remove
systemctl daemon-reload
update-rc.d glonassd.sh defaults
и перезагрузиться


Борьба с утечками памяти
http://www.ibm.com/developerworks/library/l-memory-leaks/index.html

thread stacks (s):
pmap <PID> | grep <thread stack size> | wc -l

active threads (t):
ls /proc/<PID>/task | wc -l

if s > t then threads has memory leaking!
